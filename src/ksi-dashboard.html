<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dinkes - Dashboard Kesehatan Daerah Depok</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Enhanced Design System Token Implementation */
        :root {
            /* Primary Health Colors - Softer, more professional */
            --color-primary-main: #60A5FA;
            --color-primary-light: #93BBFD;
            --color-primary-dark: #2563EB;
            
            /* Secondary Accent Colors */
            --color-secondary-main: #34D399;
            --color-secondary-light: #6EE7B7;
            --color-warning: #FBBF24;
            --color-danger: #F87171;
            
            /* Background Colors with better contrast */
            --color-background-default: #0F172A;
            --color-background-paper: rgba(30, 41, 59, 0.8);
            --color-background-elevated: #1E293B;
            --color-background-hover: rgba(30, 41, 59, 0.9);
            
            /* Text Colors with better readability */
            --color-text-primary: rgba(248, 250, 252, 0.95);
            --color-text-secondary: rgba(203, 213, 225, 0.95);
            --color-text-tertiary: rgba(148, 163, 184, 0.95);
            --color-divider: rgba(71, 85, 105, 0.5);
            
            /* Chart Colors - More vibrant and distinct */
            --color-chart-1: #60A5FA;
            --color-chart-2: #34D399;
            --color-chart-3: #A78BFA;
            --color-chart-4: #FB923C;
            --color-chart-5: #FBBF24;
            --color-chart-6: #F87171;
            --color-chart-7: #E879F9;
            --color-chart-8: #38BDF8;

            --font-family-primary: 'Inter', sans-serif;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --shadow-sm: 0px 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0px 8px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0px 16px 32px rgba(0, 0, 0, 0.5);
        }

        body {
            background: linear-gradient(135deg, var(--color-background-default) 0%, #1a2332 100%);
            color: var(--color-text-primary);
            font-family: var(--font-family-primary);
            min-height: 100vh;
        }

        /* Enhanced Glass Morphism Effect */
        .glass-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.5), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(96, 165, 250, 0.3);
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(30, 41, 59, 0.8) 100%);
        }

        /* KPI Card Styles */
        .kpi-card {
            position: relative;
            overflow: hidden;
        }

        .kpi-icon {
            position: absolute;
            right: -10px;
            top: -10px;
            opacity: 0.1;
            font-size: 80px;
            transform: rotate(-15deg);
        }

        /* Sidebar Enhancement */
        .sidebar {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(71, 85, 105, 0.3);
        }

        .sidebar-link {
            position: relative;
            transition: all 0.3s ease;
        }

        .sidebar-link:hover {
            background: rgba(96, 165, 250, 0.1);
            border-left: 3px solid var(--color-primary-main);
            padding-left: 21px;
        }

        /* Enhanced Modal */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        .modal-container {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0px 24px 48px rgba(0, 0, 0, 0.6);
        }

        /* Deep Dive Modal Styles */
        .deep-dive-modal {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0px 32px 64px rgba(0, 0, 0, 0.7);
            max-height: 85vh;
            overflow-y: auto;
        }

        /* Animated Gradient Button */
        .gradient-button {
            background: linear-gradient(135deg, var(--color-primary-main) 0%, var(--color-primary-dark) 100%);
            position: relative;
            overflow: hidden;
        }

        .gradient-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .gradient-button:hover::before {
            left: 100%;
        }

        /* Tooltip Styles */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--color-background-elevated);
            color: var(--color-text-primary);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            white-space: nowrap;
            box-shadow: var(--shadow-md);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover .tooltip-content {
            opacity: 1;
        }

        /* Loading Animation */
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Chart Container Enhancement */
        .chart-container {
            position: relative;
            padding: 4px;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);
            border-radius: var(--border-radius-md);
        }

        .chart-inner {
            background: var(--color-background-paper);
            border-radius: var(--border-radius-sm);
            padding: 16px;
        }

        /* Status Indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .status-online { background-color: var(--color-secondary-main); }
        .status-warning { background-color: var(--color-warning); }
        .status-offline { background-color: var(--color-danger); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-background-default);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-divider);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-tertiary);
        }

        /* Enhanced Leaflet Dark Theme */
        .leaflet-tile-pane {
            filter: invert(1) hue-rotate(180deg) brightness(90%) contrast(85%);
        }
        
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: var(--color-background-elevated);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-divider);
        }

        .leaflet-control {
            background: var(--color-background-paper) !important;
            border: 1px solid var(--color-divider) !important;
        }
        
        .leaflet-control a {
             color: var(--color-text-primary) !important;
        }

        /* Custom Popup Style */
        .custom-popup .leaflet-popup-content-wrapper {
            background: var(--color-background-elevated);
            color: var(--color-text-primary);
            border-radius: var(--border-radius-md);
        }

        .custom-popup .leaflet-popup-content {
            margin: 14px;
        }
        
        .custom-popup .leaflet-popup-tip-container {
            width: 40px;
            height: 20px;
        }
        .custom-popup .leaflet-popup-tip {
             box-shadow: none;
        }


        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--color-danger);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--color-divider);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary-main), var(--color-secondary-main));
            border-radius: 3px;
            transition: width 1s ease;
        }

        .metric-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            border-color: rgba(96, 165, 250, 0.4);
            background: rgba(30, 41, 59, 0.8);
        }

        .chat-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--color-text-tertiary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="flex min-h-screen text-sm lg:text-base">

    <nav id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col">
        <div class="flex items-center gap-3 h-16 px-4 border-b border-divider flex-shrink-0">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-green-500 flex items-center justify-center">
                <i data-lucide="heart-pulse" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white">Kawan Sehat</h1>
                <p class="text-xs text-slate-400">Depok Health System</p>
            </div>
        </div>
        
        <div class="flex-grow overflow-y-auto py-4">
            <ul class="space-y-1">
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 bg-blue-500/20 text-blue-300 border-l-4 border-blue-400 font-semibold relative">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                        <span class="notification-badge">3</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 text-slate-300">
                        <i data-lucide="bar-chart-3"></i>
                        <span>Analytics</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 text-slate-300">
                        <i data-lucide="map-pin"></i>
                        <span>Peta Puskesmas</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 text-slate-300">
                        <i data-lucide="users"></i>
                        <span>Data Pasien</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 text-slate-300">
                        <i data-lucide="pill"></i>
                        <span>Inventori Obat</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 text-slate-300">
                        <i data-lucide="file-text"></i>
                        <span>Laporan</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg mx-2 text-slate-300">
                        <i data-lucide="settings"></i>
                        <span>Pengaturan</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="p-4 border-t border-divider">
            <div class="glass-card p-3 mb-3">
                <p class="text-xs text-slate-400 mb-1">Status Sistem</p>
                <div class="flex items-center justify-between">
                    <span class="text-sm flex items-center">
                        <span class="status-indicator status-online"></span>
                        Online
                    </span>
                    <span class="text-xs text-slate-400">99.9% uptime</span>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-divider flex-shrink-0">
            <div class="flex items-center gap-3">
                <img src="https://placehold.co/40x40/60A5FA/FFFFFF?text=DR" alt="Dr. Admin" class="w-10 h-10 rounded-full border-2 border-blue-500">
                <div>
                    <p class="font-semibold text-white">Dr. Siti Nurhaliza</p>
                    <p class="text-xs text-slate-400">Kepala Dinkes Depok</p>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 lg:ml-64 transition-all duration-300 ease-in-out">
        <div class="p-4 sm:p-6 space-y-6">
            <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div>
                    <button id="menu-button" class="lg:hidden p-2 rounded-md hover:bg-white/10 mr-2 inline-block">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="inline-block">
                        <h1 class="text-2xl font-bold text-white">Dashboard Kesehatan Kota Depok</h1>
                        <p class="text-sm text-slate-400 mt-1">Monitoring Real-time Layanan Kesehatan Masyarakat</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 flex-wrap">
                    <select class="px-3 py-2 rounded-lg bg-slate-800 border border-divider text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option>Semua Puskesmas</option>
                        <option>Puskesmas Sukmajaya</option>
                        <option>Puskesmas Pancoran Mas</option>
                        <option>Puskesmas Beji</option>
                        <option>Puskesmas Cipayung</option>
                        <option>Puskesmas Cilodong</option>
                    </select>
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-slate-800 border border-divider">
                        <i data-lucide="calendar" class="text-slate-400 w-4 h-4"></i>
                        <span class="font-medium text-slate-200 text-sm">Juli 2024</span>
                    </div>
                    <button id="ai-chat-button" class="gradient-button flex items-center gap-2 px-4 py-2 rounded-lg text-white font-semibold shadow-lg hover:scale-105 transition-transform">
                        <i data-lucide="sparkles"></i>
                        <span class="hidden sm:inline">AI Assistant</span>
                    </button>
                </div>
            </header>

            <div class="glass-card p-4 border-l-4 border-yellow-500">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="text-yellow-500 mt-0.5"></i>
                    <div class="flex-1">
                        <h3 class="font-semibold text-yellow-500">Peringatan Dini</h3>
                        <p class="text-sm text-slate-300 mt-1">Peningkatan kasus DBD di Kecamatan Sukmajaya (15 kasus minggu ini). Tim surveilans telah dikirim untuk investigasi.</p>
                    </div>
                    <button class="text-sm text-blue-400 hover:text-blue-300">Detail ‚Üí</button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass-card kpi-card p-5 cursor-pointer transition-all hover:scale-105" onclick="openDeepDiveModal('patients')">
                    <i data-lucide="users" class="kpi-icon text-blue-400"></i>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <p class="text-slate-300">Total Pasien Terdaftar</p>
                            <div class="tooltip">
                                <i data-lucide="info" class="text-slate-400 w-4 h-4"></i>
                                <span class="tooltip-content">Klik untuk detail lengkap</span>
                            </div>
                        </div>
                        <p class="text-3xl font-bold mt-2">156,742</p>
                        <p class="text-sm text-green-400 mt-1 flex items-center gap-1">
                            <i data-lucide="trending-up" class="w-3 h-3"></i>
                            +3.2% dari bulan lalu
                        </p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 78%"></div>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">78% dari target tahunan</p>
                    </div>
                </div>
                
                <div class="glass-card kpi-card p-5 cursor-pointer transition-all hover:scale-105" onclick="openDeepDiveModal('visits')">
                    <i data-lucide="activity" class="kpi-icon text-green-400"></i>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <p class="text-slate-300">Kunjungan Hari Ini</p>
                             <div class="flex items-center">
                                <span class="status-indicator status-online !m-0 !mr-2"></span>
                                <span id="update-time" class="text-xs text-slate-400">Update: 14:32 WIB</span>
                            </div>
                        </div>
                        <p id="kunjungan-hari-ini" class="text-3xl font-bold mt-2 loading-pulse">247</p>
                        <div class="mt-4 text-xs space-y-1">
                            <div class="flex justify-between">
                                <span>Poli Umum:</span>
                                <span class="font-semibold">142</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Poli Gigi:</span>
                                <span class="font-semibold">45</span>
                            </div>
                            <div class="flex justify-between">
                                <span>IGD:</span>
                                <span class="font-semibold">60</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card kpi-card p-5 cursor-pointer transition-all hover:scale-105" onclick="openDeepDiveModal('jkn')">
                    <i data-lucide="shield-check" class="kpi-icon text-yellow-400"></i>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <p class="text-slate-300">Cakupan JKN-KIS</p>
                            <div class="tooltip">
                                <i data-lucide="info" class="text-slate-400 w-4 h-4"></i>
                                <span class="tooltip-content">Klik untuk analisis detail</span>
                            </div>
                        </div>
                        <p class="text-3xl font-bold mt-2">82.4%</p>
                        <p class="text-sm text-green-400 mt-1 flex items-center gap-1">
                            <i data-lucide="trending-up" class="w-3 h-3"></i>
                            +1.8% dari Q2
                        </p>
                        <div class="mt-2 text-xs">
                            <p>PBI: 45,231 peserta</p>
                            <p>Non-PBI: 83,902 peserta</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card kpi-card p-5 cursor-pointer transition-all hover:scale-105" onclick="openDeepDiveModal('immunization')">
                    <i data-lucide="baby" class="kpi-icon text-purple-400"></i>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <p class="text-slate-300">Imunisasi Dasar</p>
                            <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">On Track</span>
                        </div>
                        <p class="text-3xl font-bold mt-2">94.7%</p>
                        <p class="text-sm text-slate-400 mt-1">Target WHO: 95%</p>
                        <div class="mt-2 grid grid-cols-2 gap-1 text-xs">
                            <div>
                                <p class="text-slate-400">BCG</p>
                                <p class="font-semibold">98.2%</p>
                            </div>
                            <div>
                                <p class="text-slate-400">DPT-HB</p>
                                <p class="font-semibold">95.1%</p>
                            </div>
                            <div>
                                <p class="text-slate-400">Polio</p>
                                <p class="font-semibold">96.8%</p>
                            </div>
                            <div>
                                <p class="text-slate-400">Campak</p>
                                <p class="font-semibold text-yellow-400">93.4%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-card p-5 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">Tren Kunjungan Harian & Prediksi</h3>
                        <div class="flex gap-2">
                            <button class="text-xs px-3 py-1 rounded bg-blue-500/20 text-blue-300 border border-blue-500/30">7 Hari</button>
                            <button class="text-xs px-3 py-1 rounded hover:bg-white/10 text-slate-400">30 Hari</button>
                            <button class="text-xs px-3 py-1 rounded hover:bg-white/10 text-slate-400">3 Bulan</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-inner h-72">
                            <canvas id="dailyVisitsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5">
                    <h3 class="font-semibold text-white mb-4">Program Prioritas</h3>
                    <div class="space-y-3">
                        <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-green-400">Stunting</span>
                                <span class="text-sm text-green-400">87%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 87%; background: var(--color-secondary-main)"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">1,247 dari 1,432 balita terukur</p>
                        </div>
                        <div class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-blue-400">TB-DOTS</span>
                                <span class="text-sm text-blue-400">72%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 72%; background: var(--color-primary-main)"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">89 dari 123 pasien dalam pengobatan</p>
                        </div>
                        <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-yellow-400">Lansia Sehat</span>
                                <span class="text-sm text-yellow-400">65%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 65%; background: var(--color-warning)"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">3,421 dari 5,263 lansia terpantau</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">10 Diagnosa Terbanyak (ICD-10)</h3>
                        <button class="text-sm text-blue-400 hover:text-blue-300">Lihat Semua ‚Üí</button>
                    </div>
                    <div class="chart-container">
                        <div class="chart-inner h-80">
                            <canvas id="topDiagnosesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5">
                    <h3 class="font-semibold text-white mb-4">Kunjungan per Jenis Pembiayaan</h3>
                    <div class="h-72">
                        <canvas id="visitsByInsuranceChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded" style="background-color: #667eea;"></span>
                                JKN-KIS PBI
                            </span>
                            <span class="font-semibold">1,847</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded" style="background-color: #f093fb;"></span>
                                JKN-KIS Non-PBI
                            </span>
                            <span class="font-semibold">982</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded" style="background-color: #4facfe;"></span>
                                Umum/Pribadi
                            </span>
                            <span class="font-semibold">299</span>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">10 Obat Paling Banyak Diresepkan</h3>
                        <button id="medications-detail-btn" class="text-sm text-blue-400 hover:text-blue-300 cursor-pointer">Lihat Detail ‚Üí</button>
                    </div>
                    <div class="chart-container">
                        <div class="chart-inner h-80">
                            <canvas id="topMedicationsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="glass-card p-5">
                    <h3 class="font-semibold text-white mb-4">Stok Obat Kritis</h3>
                    <div class="space-y-3">
                        <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-red-400">Amoxicillin 500mg</span>
                                <span class="text-sm text-red-400">12%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 12%; background: var(--color-danger)"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">289 tablet tersisa dari 2,400</p>
                        </div>
                        <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-yellow-400">Paracetamol 500mg</span>
                                <span class="text-sm text-yellow-400">23%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 23%; background: var(--color-warning)"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">1,150 tablet tersisa dari 5,000</p>
                        </div>
                        <div class="p-3 rounded-lg bg-orange-500/10 border border-orange-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-orange-400">ORS Sachet</span>
                                <span class="text-sm text-orange-400">31%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 31%; background: #FB923C"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">186 sachet tersisa dari 600</p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-green-400">Vitamin B Complex</span>
                                <span class="text-sm text-green-400">78%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 78%; background: var(--color-secondary-main)"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">1,560 tablet tersisa dari 2,000</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-card p-5 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">Peta Sebaran Fasilitas Kesehatan Depok</h3>
                    </div>
                    <div id="map" class="h-96 rounded-lg -m-5"></div>
                </div>
                
                <div class="glass-card p-5">
                    <h3 class="font-semibold text-white mb-4">Kunjungan per Kecamatan</h3>
                    <div class="space-y-3 overflow-y-auto h-96 pr-2">
                         <div class="p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Sukmajaya</span>
                                <span class="font-bold text-white">687</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 100%"></div></div>
                            <p class="text-xs text-slate-400 mt-1">Puskesmas: Sukmajaya, Mekarjaya</p>
                        </div>
                        <div class="p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Pancoran Mas</span>
                                <span class="font-bold text-white">623</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 91%"></div></div>
                            <p class="text-xs text-slate-400 mt-1">Puskesmas: Pancoran Mas, Rangkapan Jaya</p>
                        </div>
                        <div class="p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Beji</span>
                                <span class="font-bold text-white">589</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 86%"></div></div>
                            <p class="text-xs text-slate-400 mt-1">Puskesmas: Beji, Kemiri Muka</p>
                        </div>
                        <div class="p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Cipayung</span>
                                <span class="font-bold text-white">456</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 66%"></div></div>
                            <p class="text-xs text-slate-400 mt-1">Puskesmas: Cipayung, Ratu Jaya</p>
                        </div>
                        <div class="p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Cilodong</span>
                                <span class="font-bold text-white">412</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 60%"></div></div>
                            <p class="text-xs text-slate-400 mt-1">Puskesmas: Cilodong, Kalibaru</p>
                        </div>
                        <div class="p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">Cimanggis</span>
                                <span class="font-bold text-white">361</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 53%"></div></div>
                            <p class="text-xs text-slate-400 mt-1">Puskesmas: Cimanggis, Harjamukti</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="ai-chat-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="modal-container w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-divider flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center">
                        <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">AI Health Assistant</h2>
                        <p class="text-xs text-slate-400">Powered by Machine Learning</p>
                    </div>
                </div>
                <button id="close-modal-button" class="p-2 rounded-full hover:bg-white/10">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="p-4 border-b border-divider flex gap-2 overflow-x-auto">
                <button class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-300 text-sm whitespace-nowrap hover:bg-blue-500/30">
                    üìä Analisis tren DBD
                </button>
                <button class="px-3 py-1 rounded-full bg-green-500/20 text-green-300 text-sm whitespace-nowrap hover:bg-green-500/30">
                    üíä Prediksi stok obat
                </button>
                <button class="px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-300 text-sm whitespace-nowrap hover:bg-yellow-500/30">
                    üè• Optimasi jadwal dokter
                </button>
            </div>
            
            <div class="flex-grow p-4 overflow-y-auto space-y-4" id="chat-messages">
                <div class="flex items-start gap-3 chat-message">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex-shrink-0 flex items-center justify-center">
                        <i data-lucide="bot" class="w-5 h-5"></i>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-3 max-w-md">
                        <p>Halo! Saya siap membantu menganalisis data kesehatan Kota Depok. Ada yang bisa saya bantu hari ini?</p>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button class="quick-reply px-3 py-1 bg-blue-600/20 text-blue-300 rounded-full text-sm hover:bg-blue-600/30" data-reply="Bagaimana tren kasus DBD di Sukmajaya?">
                                üìä Tren DBD
                            </button>
                            <button class="quick-reply px-3 py-1 bg-green-600/20 text-green-300 rounded-full text-sm hover:bg-green-600/30" data-reply="Analisis tingkat kepuasan pasien">
                                üòä Kepuasan Pasien
                            </button>
                            <button class="quick-reply px-3 py-1 bg-yellow-600/20 text-yellow-300 rounded-full text-sm hover:bg-yellow-600/30" data-reply="Prediksi kebutuhan obat minggu depan">
                                üíä Prediksi Obat
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-divider flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button class="p-2 rounded-lg hover:bg-white/10">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                    </button>
                    <input type="text" id="chat-input" placeholder="Ketik pertanyaan Anda..." class="flex-grow bg-slate-800 border border-divider rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="send-message" class="gradient-button p-2 rounded-lg text-white">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-xs text-slate-400 mt-2">AI dapat membantu analisis data, prediksi tren, dan rekomendasi kesehatan</p>
            </div>
        </div>
    </div>
    
    <!-- Deep Dive Modal -->
    <div id="deep-dive-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="deep-dive-modal w-full max-w-6xl">
            <div class="flex items-center justify-between p-6 border-b border-divider">
                <div class="flex items-center gap-3">
                    <div id="modal-icon" class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-green-500 flex items-center justify-center">
                        <i data-lucide="users" class="w-7 h-7 text-white"></i>
                    </div>
                    <div>
                        <h2 id="modal-title" class="text-xl font-bold text-white">Detail Analisis</h2>
                        <p id="modal-subtitle" class="text-sm text-slate-400">Data lengkap dan insights</p>
                    </div>
                </div>
                <button id="close-deep-dive-modal" class="p-2 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="modal-content" class="p-6">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA SETS ---
            const dailyVisitsData = {
                labels: Array.from({ length: 37 }, (_, i) => `2024-07-${String(i + 1).padStart(2, '0')}`),
                datasets: [{
                    label: 'Kunjungan Aktual',
                    data: [180, 195, 205, 215, 220, 198, 187, 210, 225, 235, 240, 228, 195, 185, 205, 225, 235, 245, 255, 240, 225, 260, 275, 265, 245, 220, 195, 210, 225, 240, 247, null, null, null, null, null, null],
                    borderColor: '#00D9FF',
                    backgroundColor: 'rgba(0, 217, 255, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#00D9FF',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#00D9FF',
                    pointHoverBorderColor: '#FFFFFF',
                    pointHoverBorderWidth: 3,
                    spanGaps: false,
                }, {
                    label: 'Prediksi',
                    data: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, 247, 252, 258, 265, 270, 275, 282],
                    borderColor: '#FF6B6B',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    borderDash: [8, 4],
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#FF6B6B',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#FF6B6B',
                    pointHoverBorderColor: '#FFFFFF',
                    pointHoverBorderWidth: 3,
                    spanGaps: false,
                }]
            };

            const visitsByInsuranceData = {
                labels: ['JKN-KIS PBI', 'JKN-KIS Non-PBI', 'Umum/Pribadi'],
                datasets: [{
                    data: [1847, 982, 299],
                    backgroundColor: [
                        '#667eea',
                        '#f093fb', 
                        '#4facfe'
                    ],
                    borderWidth: 4,
                    borderColor: '#1E293B',
                    hoverBorderWidth: 6,
                    hoverBorderColor: '#1E293B',
                    hoverOffset: 8,
                    cutout: '65%'
                }]
            };
            
            const topDiagnosesData = {
                labels: ['J06.9 - ISPA', 'I10 - Hipertensi', 'E11.9 - Diabetes', 'A09 - Diare', 'K29.7 - Gastritis', 'K04.7 - Abses Gigi', 'R50.9 - Demam', 'J45.9 - Asma', 'L23.9 - Dermatitis', 'H10.9 - Konjungtivitis'],
                datasets: [{
                    label: 'Jumlah Kasus',
                    data: [687, 523, 456, 398, 342, 289, 265, 234, 198, 167],
                    backgroundColor: [
                        'linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%)',
                        'linear-gradient(135deg, #34D399 0%, #10B981 100%)', 
                        'linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%)',
                        'linear-gradient(135deg, #FB923C 0%, #F97316 100%)',
                        'linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%)',
                        'linear-gradient(135deg, #F87171 0%, #EF4444 100%)',
                        'linear-gradient(135deg, #E879F9 0%, #D946EF 100%)',
                        'linear-gradient(135deg, #38BDF8 0%, #0EA5E9 100%)',
                        'linear-gradient(135deg, #FB7185 0%, #F43F5E 100%)',
                        'linear-gradient(135deg, #4ADE80 0%, #22C55E 100%)'
                    ],
                    borderColor: [
                        '#60A5FA', '#34D399', '#A78BFA', '#FB923C', '#FBBF24',
                        '#F87171', '#E879F9', '#38BDF8', '#FB7185', '#4ADE80'
                    ],
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            };

            const topMedicationsData = {
                labels: ['Paracetamol 500mg', 'Amoxicillin 500mg', 'ORS Sachet', 'Vitamin B Complex', 'Antasida DOEN', 'CTM 4mg', 'Ibuprofen 400mg', 'Salep 2-4', 'Dextromethorphan', 'Betadine Solution'],
                datasets: [{
                    label: 'Jumlah Resep',
                    data: [1245, 897, 654, 589, 445, 398, 367, 298, 267, 189],
                    backgroundColor: [
                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
                        '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                        '#BB8FCE', '#85C1E9'
                    ],
                    borderColor: [
                        '#FF5252', '#26A69A', '#2196F3', '#66BB6A',
                        '#FFD54F', '#BA68C8', '#4DB6AC', '#FDD835',
                        '#9575CD', '#42A5F5'
                    ],
                    borderWidth: 2,
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            };

            const puskesmasData = [
                { name: 'Puskesmas Sukmajaya', lat: -6.3889, lon: 106.8333, visits: 687, status: 'high' },
                { name: 'Puskesmas Pancoran Mas', lat: -6.3920, lon: 106.8100, visits: 623, status: 'high' },
                { name: 'Puskesmas Beji', lat: -6.3677, lon: 106.8219, visits: 589, status: 'normal' },
                { name: 'Puskesmas Cipayung', lat: -6.4289, lon: 106.8138, visits: 456, status: 'normal' },
                { name: 'Puskesmas Cilodong', lat: -6.4380, lon: 106.8347, visits: 412, status: 'normal' },
                { name: 'Puskesmas Cimanggis', lat: -6.3719, lon: 106.8584, visits: 361, status: 'normal' },
                { name: 'Puskesmas Limo', lat: -6.3694, lon: 106.7731, visits: 298, status: 'normal' },
                { name: 'Puskesmas Sawangan', lat: -6.4024, lon: 106.7745, visits: 276, status: 'normal' },
            ];

            // --- CHART CONFIGURATIONS ---
            const createBaseChartOptions = () => ({
                maintainAspectRatio: false,
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#F1F5F9',
                        bodyColor: '#CBD5E1',
                        titleFont: { size: 14, family: 'Inter', weight: '600' },
                        bodyFont: { size: 12, family: 'Inter' },
                        padding: 12,
                        cornerRadius: 8,
                        borderColor: 'rgba(148, 163, 184, 0.3)',
                        borderWidth: 1,
                        displayColors: true,
                        boxPadding: 6
                    }
                },
                scales: {
                    x: {
                        grid: { 
                            color: 'rgba(148, 163, 184, 0.15)',
                            drawBorder: false,
                            lineWidth: 1
                        },
                        ticks: { 
                            color: '#94A3B8',
                            font: { family: 'Inter', size: 11 }
                        },
                        border: { display: false }
                    },
                    y: {
                        grid: { 
                            color: 'rgba(148, 163, 184, 0.15)',
                            drawBorder: false,
                            lineWidth: 1
                        },
                        ticks: { 
                            color: '#94A3B8',
                            font: { family: 'Inter', size: 11 }
                        },
                        border: { display: false }
                    }
                }
            });

            // --- CHART RENDERING ---
            const dailyVisitsCtx = document.getElementById('dailyVisitsChart');
            if(dailyVisitsCtx) {
                const options = createBaseChartOptions();
                options.plugins.legend.display = true;
                options.plugins.legend.position = 'top';
                options.plugins.legend.align = 'end';
                options.plugins.legend.labels = { 
                    color: '#CBD5E1',
                    font: { family: 'Inter', size: 11 },
                    boxWidth: 12,
                    padding: 10,
                    usePointStyle: true,
                    pointStyle: 'circle'
                };
                
                // Improve tooltip to show prediction vs actual
                options.plugins.tooltip.callbacks = {
                    title: function(tooltipItems) {
                        const date = new Date(tooltipItems[0].label);
                        return date.toLocaleDateString('id-ID', { 
                            day: 'numeric', 
                            month: 'long',
                            year: 'numeric'
                        });
                    },
                    label: function(context) {
                        const value = context.parsed.y;
                        const label = context.dataset.label;
                        if (value === null) return null;
                        return `${label}: ${value.toLocaleString()} kunjungan`;
                    }
                };
                
                // Configure scales for better date handling
                options.scales.x.type = 'category';
                options.scales.x.ticks.maxTicksLimit = 10;
                options.scales.x.ticks.callback = function(value, index) {
                    const label = this.getLabelForValue(value);
                    const day = parseInt(label.split('-')[2]);
                    return day % 3 === 1 ? `${day} Jul` : '';
                };
                
                // Ensure prediction line shows properly
                options.spanGaps = false;
                options.plugins.legend.onClick = null; // Disable legend click to keep both lines visible
                
                new Chart(dailyVisitsCtx, { type: 'line', data: dailyVisitsData, options });
            }

            const visitsByInsuranceCtx = document.getElementById('visitsByInsuranceChart');
            if(visitsByInsuranceCtx) {
                const options = createBaseChartOptions();
                options.plugins.legend = { 
                    display: false 
                };
                options.plugins.tooltip.callbacks = {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                    }
                };
                new Chart(visitsByInsuranceCtx, { type: 'doughnut', data: visitsByInsuranceData, options });
            }

            const topDiagnosesCtx = document.getElementById('topDiagnosesChart');
            if(topDiagnosesCtx) {
                const options = createBaseChartOptions();
                options.indexAxis = 'y';
                options.scales.x.ticks.maxRotation = 0;
                options.scales.x.ticks.minRotation = 0;
                options.scales.x.ticks.color = '#94A3B8';
                options.scales.y.ticks.color = '#94A3B8';
                options.plugins.tooltip.callbacks = {
                    title: (tooltipItems) => tooltipItems[0].label.split(' - ')[1],
                    label: (context) => {
                        const code = context.label.split(' - ')[0];
                        const value = new Intl.NumberFormat('id-ID').format(context.parsed.x);
                        return [`Kode ICD-10: ${code}`, `Jumlah: ${value} kasus`];
                    }
                };
                options.scales.y.grid.display = false;
                options.scales.x.grid.color = 'rgba(148, 163, 184, 0.1)';
                new Chart(topDiagnosesCtx, { type: 'bar', data: topDiagnosesData, options });
            }

            const topMedicationsCtx = document.getElementById('topMedicationsChart');
            if(topMedicationsCtx) {
                const options = createBaseChartOptions();
                options.indexAxis = 'y';
                options.scales.x.ticks.maxRotation = 0;
                options.scales.x.ticks.minRotation = 0;
                options.scales.x.ticks.color = '#94A3B8';
                options.scales.y.ticks.color = '#94A3B8';
                options.plugins.tooltip.callbacks = {
                    title: (tooltipItems) => tooltipItems[0].label,
                    label: (context) => {
                        const value = new Intl.NumberFormat('id-ID').format(context.parsed.x);
                        return `Jumlah resep: ${value}`;
                    }
                };
                options.scales.y.grid.display = false;
                options.scales.x.grid.color = 'rgba(148, 163, 184, 0.1)';
                options.plugins.legend.display = false;
                options.onClick = (event, elements) => {
                    if (elements.length > 0) {
                        const dataIndex = elements[0].index;
                        const medication = topMedicationsData.labels[dataIndex];
                        openMedicationDetail(medication, dataIndex);
                    }
                };
                new Chart(topMedicationsCtx, { type: 'bar', data: topMedicationsData, options });
            }

            // --- LEAFLET MAP ---
            const mapElement = document.getElementById('map');
            if (mapElement) {
                const map = L.map('map', { center: [-6.39, 106.82], zoom: 12, zoomControl: false });
                L.control.zoom({ position: 'topright' }).addTo(map);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd', maxZoom: 20
                }).addTo(map);

                const statusColors = { high: '#F87171', normal: '#FBBF24', low: '#34D399' };
                const createIcon = (color) => L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [16, 16], iconAnchor: [8, 8]
                });

                puskesmasData.forEach(p => {
                    const color = statusColors[p.status] || '#60A5FA';
                    const popupContent = `
                        <div class="text-white" style="min-width: 180px;">
                            <h4 class="font-bold text-base mb-2">${p.name}</h4>
                            <div class="space-y-1 text-xs">
                                <p><strong>Kunjungan:</strong> ${p.visits}</p>
                                <p><strong>Status:</strong> <span style="color: ${color};">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span></p>
                                <p><strong>Jam:</strong> 08:00 - 16:00</p>
                            </div>
                        </div>`;
                    L.marker([p.lat, p.lon], { icon: createIcon(color) })
                     .addTo(map)
                     .bindPopup(popupContent, { maxWidth: 250, className: 'custom-popup' });
                });

                L.circle([-6.3889, 106.8333], {
                    color: '#F87171', fillColor: '#F87171', fillOpacity: 0.15, radius: 1500, weight: 1.5
                }).addTo(map).bindPopup('Area Peringatan: Kasus DBD Tinggi');
            }


            // --- UI INTERACTIONS ---
            const sidebar = document.getElementById('sidebar');
            const menuButton = document.getElementById('menu-button');
            if(menuButton) menuButton.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 1024 && !sidebar.contains(e.target) && !menuButton.contains(e.target) && !sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.add('-translate-x-full');
                }
            });
            
            // --- AI CHAT FUNCTIONALITY ---
            const aiChatModal = document.getElementById('ai-chat-modal');
            const aiChatButton = document.getElementById('ai-chat-button');
            const closeModalButton = document.getElementById('close-modal-button');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-message');
            
            const aiResponses = {
                'tren dbd': {
                    text: 'Berdasarkan analisis data, terjadi peningkatan signifikan kasus DBD di Kecamatan Sukmajaya:',
                    data: `<div class="bg-slate-900 rounded-lg p-3 mb-3">
                        <p class="text-sm font-semibold mb-2">Statistik DBD Sukmajaya (Juli 2024)</p>
                        <ul class="space-y-1 text-sm">
                            <li>‚Ä¢ Minggu 1: 2 kasus</li>
                            <li>‚Ä¢ Minggu 2: 3 kasus</li>
                            <li>‚Ä¢ Minggu 3: 5 kasus</li>
                            <li>‚Ä¢ Minggu 4: <span class="text-red-400 font-semibold">15 kasus</span> ‚ö†Ô∏è</li>
                        </ul>
                    </div>`,
                    recommendations: [
                        'Lakukan fogging di RW dengan kasus tertinggi',
                        'Tingkatkan penyuluhan 3M Plus',
                        'Koordinasi dengan kelurahan untuk PSN'
                    ]
                },
                'kepuasan pasien': {
                    text: 'Analisis tingkat kepuasan pasien menunjukkan hasil yang positif:',
                    data: `<div class="bg-slate-900 rounded-lg p-3 mb-3">
                        <p class="text-sm font-semibold mb-2">Survey Kepuasan Pasien Q2 2024</p>
                        <ul class="space-y-1 text-sm">
                            <li>‚Ä¢ Pelayanan Dokter: <span class="text-green-400 font-semibold">4.2/5.0</span> ‚≠ê</li>
                            <li>‚Ä¢ Fasilitas: <span class="text-green-400 font-semibold">4.0/5.0</span> ‚≠ê</li>
                            <li>‚Ä¢ Waktu Tunggu: <span class="text-yellow-400 font-semibold">3.7/5.0</span> ‚≠ê</li>
                            <li>‚Ä¢ Kebersihan: <span class="text-green-400 font-semibold">4.4/5.0</span> ‚≠ê</li>
                        </ul>
                    </div>`,
                    recommendations: [
                        'Implementasi sistem antrian digital',
                        'Pelatihan customer service',
                        'Perbaikan sistem informasi pasien'
                    ]
                },
                'prediksi obat': {
                    text: 'Prediksi kebutuhan obat berdasarkan pola kunjungan dan musim:',
                    data: `<div class="bg-slate-900 rounded-lg p-3 mb-3">
                        <p class="text-sm font-semibold mb-2">Prediksi Kebutuhan Obat (15-22 Juli)</p>
                        <ul class="space-y-1 text-sm">
                            <li>‚Ä¢ Paracetamol: <span class="text-blue-400 font-semibold">2,450 tablet</span> (+12%)</li>
                            <li>‚Ä¢ Amoxicillin: <span class="text-green-400 font-semibold">890 kapsul</span> (+5%)</li>
                            <li>‚Ä¢ ORS: <span class="text-yellow-400 font-semibold">156 sachet</span> (+18%)</li>
                            <li>‚Ä¢ Antasida: <span class="text-purple-400 font-semibold">340 tablet</span> (+8%)</li>
                        </ul>
                    </div>`,
                    recommendations: [
                        'Pesan tambahan ORS mengantisipasi musim hujan',
                        'Monitor stok Paracetamol di semua Puskesmas',
                        'Koordinasi dengan apotek untuk backup supply'
                    ]
                }
            };

            const getAIResponse = (message) => {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('dbd') || lowerMessage.includes('demam berdarah')) {
                    return aiResponses['tren dbd'];
                } else if (lowerMessage.includes('kepuasan') || lowerMessage.includes('survey')) {
                    return aiResponses['kepuasan pasien'];
                } else if (lowerMessage.includes('obat') || lowerMessage.includes('prediksi')) {
                    return aiResponses['prediksi obat'];
                } else if (lowerMessage.includes('halo') || lowerMessage.includes('hai')) {
                    return {
                        text: 'Halo! Senang bisa membantu Anda. Saya dapat menganalisis berbagai aspek data kesehatan Kota Depok.',
                        recommendations: [
                            'Tanyakan tentang tren penyakit',
                            'Minta analisis kepuasan pasien',
                            'Diskusikan prediksi kebutuhan obat'
                        ]
                    };
                } else {
                    return {
                        text: 'Maaf, saya belum memahami pertanyaan tersebut. Saya dapat membantu dengan analisis data kesehatan, tren penyakit, dan prediksi kebutuhan medis.',
                        recommendations: [
                            'Coba tanyakan tentang DBD di Sukmajaya',
                            'Tanyakan tingkat kepuasan pasien',
                            'Minta prediksi kebutuhan obat'
                        ]
                    };
                }
            };

            const addMessage = (content, isUser = false) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start gap-3 chat-message ${isUser ? 'justify-end' : ''}`;
                
                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="bg-blue-600 rounded-lg p-3 max-w-md">
                            <p>${content}</p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-slate-600 flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                    `;
                } else {
                    const response = getAIResponse(content);
                    const recommendationsHtml = response.recommendations ? 
                        `<div class="mt-3 flex flex-wrap gap-2">
                            ${response.recommendations.map(rec => 
                                `<span class="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">üí° ${rec}</span>`
                            ).join('')}
                        </div>` : '';
                        
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="bot" class="w-5 h-5"></i>
                        </div>
                        <div class="bg-slate-800 rounded-lg p-3 max-w-lg">
                            <p class="mb-3">${response.text}</p>
                            ${response.data || ''}
                            ${recommendationsHtml}
                        </div>
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                lucide.createIcons();
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const showTypingIndicator = () => {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex items-start gap-3 typing-message';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex-shrink-0 flex items-center justify-center">
                        <i data-lucide="bot" class="w-5 h-5"></i>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-3">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                setTimeout(() => {
                    chatMessages.removeChild(typingDiv);
                }, 1500);
            };

            const sendMessage = () => {
                const message = chatInput.value.trim();
                if (!message) return;
                
                addMessage(message, true);
                chatInput.value = '';
                
                showTypingIndicator();
                setTimeout(() => {
                    addMessage(message, false);
                }, 1500);
            };

            // Event listeners for chat
            if (sendButton) sendButton.addEventListener('click', sendMessage);
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
            }

            // Quick reply buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('quick-reply')) {
                    const reply = e.target.getAttribute('data-reply');
                    chatInput.value = reply;
                    sendMessage();
                }
            });

            const openModal = () => {
                aiChatModal.classList.remove('hidden');
                setTimeout(() => chatInput.focus(), 100);
            };
            const closeModal = () => aiChatModal.classList.add('hidden');

            if(aiChatButton) aiChatButton.addEventListener('click', openModal);
            if(closeModalButton) closeModalButton.addEventListener('click', closeModal);
            if(aiChatModal) aiChatModal.addEventListener('click', (e) => e.target === aiChatModal && closeModal());
            
            // --- DEEP DIVE MODAL FUNCTIONALITY ---
            const deepDiveModalElement = document.getElementById('deep-dive-modal');
            const closeDeepDiveModalBtn = document.getElementById('close-deep-dive-modal');
            
            const deepDiveData = {
                patients: {
                    title: 'Detail Pasien Terdaftar',
                    subtitle: 'Analisis komprehensif data pasien',
                    icon: 'users',
                    content: `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="data-grid lg:col-span-2">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-2">Demografi Pasien</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Usia 0-17:</span><span class="font-semibold">42,450 (27.1%)</span></div>
                                        <div class="flex justify-between"><span>Usia 18-59:</span><span class="font-semibold">89,320 (57.0%)</span></div>
                                        <div class="flex justify-between"><span>Usia 60+:</span><span class="font-semibold">24,972 (15.9%)</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-2">Distribusi Gender</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Perempuan:</span><span class="font-semibold">81,235 (51.8%)</span></div>
                                        <div class="flex justify-between"><span>Laki-laki:</span><span class="font-semibold">75,507 (48.2%)</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-2">Status Kepesertaan</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>JKN-KIS PBI:</span><span class="font-semibold">89,430 (57.1%)</span></div>
                                        <div class="flex justify-between"><span>JKN-KIS Non-PBI:</span><span class="font-semibold">52,890 (33.7%)</span></div>
                                        <div class="flex justify-between"><span>Umum:</span><span class="font-semibold">14,422 (9.2%)</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-2">Kecamatan Terbanyak</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Sukmajaya:</span><span class="font-semibold">28,450</span></div>
                                        <div class="flex justify-between"><span>Pancoran Mas:</span><span class="font-semibold">25,630</span></div>
                                        <div class="flex justify-between"><span>Beji:</span><span class="font-semibold">23,890</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-green-400 mb-2">üìà Insight Positif</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Cakupan registrasi meningkat 3.2%</li>
                                        <li>‚Ä¢ Partisipasi JKN-KIS naik signifikan</li>
                                        <li>‚Ä¢ Data valid & terintegrasi baik</li>
                                    </ul>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-yellow-400 mb-2">‚ö†Ô∏è Area Perhatian</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Pendaftaran lansia perlu ditingkatkan</li>
                                        <li>‚Ä¢ Beberapa data masih pending verifikasi</li>
                                        <li>‚Ä¢ Update alamat pasien berkala</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                visits: {
                    title: 'Detail Kunjungan Harian',
                    subtitle: 'Real-time monitoring dan analisis trend',
                    icon: 'activity',
                    content: `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Kunjungan per Jam Hari Ini</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>07:00-08:00:</span><span class="font-semibold">45 pasien</span></div>
                                        <div class="flex justify-between"><span>08:00-09:00:</span><span class="font-semibold text-green-400">67 pasien</span></div>
                                        <div class="flex justify-between"><span>09:00-10:00:</span><span class="font-semibold text-green-400">82 pasien</span></div>
                                        <div class="flex justify-between"><span>10:00-11:00:</span><span class="font-semibold">56 pasien</span></div>
                                        <div class="flex justify-between"><span>11:00-12:00:</span><span class="font-semibold">34 pasien</span></div>
                                        <div class="flex justify-between"><span>13:00-14:00:</span><span class="font-semibold text-blue-400">23 pasien (live)</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Perbandingan 7 Hari</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Senin:</span><span class="font-semibold">289 pasien</span></div>
                                        <div class="flex justify-between"><span>Selasa:</span><span class="font-semibold">267 pasien</span></div>
                                        <div class="flex justify-between"><span>Rabu:</span><span class="font-semibold">234 pasien</span></div>
                                        <div class="flex justify-between"><span>Kamis:</span><span class="font-semibold">256 pasien</span></div>
                                        <div class="flex justify-between"><span>Jumat:</span><span class="font-semibold">189 pasien</span></div>
                                        <div class="flex justify-between"><span>Sabtu:</span><span class="font-semibold">167 pasien</span></div>
                                        <div class="flex justify-between"><span>Minggu (Hari ini):</span><span class="font-semibold text-green-400">247 pasien ‚ÜóÔ∏è</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Detail per Layanan</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Poli Umum:</span><span class="font-semibold">142 (57.5%)</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-blue-400 h-2 rounded-full" style="width: 57.5%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>IGD:</span><span class="font-semibold">60 (24.3%)</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-red-400 h-2 rounded-full" style="width: 24.3%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Poli Gigi:</span><span class="font-semibold">45 (18.2%)</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 18.2%"></div></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-purple-400 mb-2">üéØ Prediksi & Rekomendasi</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Prediksi sore: +89 pasien</li>
                                        <li>‚Ä¢ Persiapkan tenaga tambahan pkl 15:00</li>
                                        <li>‚Ä¢ Monitor antrian IGD</li>
                                        <li>‚Ä¢ Update sistem real-time</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                jkn: {
                    title: 'Analisis Cakupan JKN-KIS',
                    subtitle: 'Monitoring program jaminan kesehatan nasional',
                    icon: 'shield-check',
                    content: `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="data-grid lg:col-span-2">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Cakupan per Kecamatan</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Sukmajaya:</span><span class="font-semibold">85.2%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 85.2%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Pancoran Mas:</span><span class="font-semibold">83.7%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 83.7%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Beji:</span><span class="font-semibold">81.4%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-yellow-400 h-2 rounded-full" style="width: 81.4%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Cipayung:</span><span class="font-semibold">79.8%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-yellow-400 h-2 rounded-full" style="width: 79.8%"></div></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-2">Segmentasi Peserta</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>PBI (Penerima Bantuan):</span><span class="font-semibold text-blue-400">89,430 (64.2%)</span></div>
                                        <div class="flex justify-between"><span>Non-PBI Pekerja:</span><span class="font-semibold text-green-400">32,890 (23.6%)</span></div>
                                        <div class="flex justify-between"><span>Non-PBI Mandiri:</span><span class="font-semibold text-purple-400">17,020 (12.2%)</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-2">Trend Pendaftaran Bulanan</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Mei 2024:</span><span class="font-semibold">+1,245 peserta</span></div>
                                        <div class="flex justify-between"><span>Juni 2024:</span><span class="font-semibold">+1,567 peserta</span></div>
                                        <div class="flex justify-between"><span>Juli 2024:</span><span class="font-semibold text-green-400">+1,890 peserta ‚ÜóÔ∏è</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-green-400 mb-2">‚úÖ Pencapaian</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Target nasional 80% tercapai</li>
                                        <li>‚Ä¢ Integrasi data DUKCAPIL 95%</li>
                                        <li>‚Ä¢ Sosialisasi aktif di 11 kecamatan</li>
                                        <li>‚Ä¢ Partnership dengan RT/RW</li>
                                    </ul>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-blue-400 mb-2">üéØ Target & Strategi</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Target akhir tahun: 90%</li>
                                        <li>‚Ä¢ Focus area: Cipayung & Cilodong</li>
                                        <li>‚Ä¢ Mobile registration program</li>
                                        <li>‚Ä¢ Edukasi manfaat JKN-KIS</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                immunization: {
                    title: 'Program Imunisasi Dasar',
                    subtitle: 'Monitoring cakupan imunisasi dan target WHO',
                    icon: 'baby',
                    content: `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Detail Cakupan per Jenis</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between mb-1"><span>BCG:</span><span class="font-semibold text-green-400">98.2%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 98.2%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Polio:</span><span class="font-semibold text-green-400">96.8%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 96.8%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>DPT-HB:</span><span class="font-semibold text-green-400">95.1%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 95.1%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between mb-1"><span>Campak:</span><span class="font-semibold text-yellow-400">93.4%</span></div>
                                            <div class="w-full bg-slate-600 rounded-full h-2"><div class="bg-yellow-400 h-2 rounded-full" style="width: 93.4%"></div></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Sasaran Bulanan</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Bayi Baru Lahir:</span><span class="font-semibold">567 bayi</span></div>
                                        <div class="flex justify-between"><span>Sudah Diimunisasi:</span><span class="font-semibold text-green-400">537 bayi (94.7%)</span></div>
                                        <div class="flex justify-between"><span>Menunggu Jadwal:</span><span class="font-semibold text-yellow-400">23 bayi</span></div>
                                        <div class="flex justify-between"><span>Perlu Follow-up:</span><span class="font-semibold text-red-400">7 bayi</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Distribusi per Puskesmas</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Sukmajaya:</span><span class="font-semibold text-green-400">96.8%</span></div>
                                        <div class="flex justify-between"><span>Pancoran Mas:</span><span class="font-semibold text-green-400">95.2%</span></div>
                                        <div class="flex justify-between"><span>Beji:</span><span class="font-semibold text-green-400">94.1%</span></div>
                                        <div class="flex justify-between"><span>Cipayung:</span><span class="font-semibold text-yellow-400">92.7%</span></div>
                                        <div class="flex justify-between"><span>Cilodong:</span><span class="font-semibold text-yellow-400">91.9%</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-purple-400 mb-2">üìã Action Plan</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Sweeping imunisasi Campak di Cipayung</li>
                                        <li>‚Ä¢ Reminder otomatis untuk jadwal</li>
                                        <li>‚Ä¢ Koordinasi dengan bidan desa</li>
                                        <li>‚Ä¢ Edukasi pentingnya imunisasi lengkap</li>
                                        <li>‚Ä¢ Target 95% untuk semua jenis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                medications: {
                    title: 'Analisis Obat Paling Banyak Diresepkan',
                    subtitle: 'Detail pola peresepan dan trend bulanan',
                    icon: 'pill',
                    content: `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Top 5 Obat Juli 2024</h4>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center p-2 rounded bg-slate-800/50">
                                            <span class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-red-500 text-white text-xs flex items-center justify-center">1</span>
                                                Paracetamol 500mg
                                            </span>
                                            <div class="text-right">
                                                <span class="font-semibold text-red-400">1,245</span>
                                                <p class="text-xs text-slate-400">+8% vs Juni</p>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center p-2 rounded bg-slate-800/50">
                                            <span class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-teal-500 text-white text-xs flex items-center justify-center">2</span>
                                                Amoxicillin 500mg
                                            </span>
                                            <div class="text-right">
                                                <span class="font-semibold text-teal-400">897</span>
                                                <p class="text-xs text-slate-400">+12% vs Juni</p>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center p-2 rounded bg-slate-800/50">
                                            <span class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center">3</span>
                                                ORS Sachet
                                            </span>
                                            <div class="text-right">
                                                <span class="font-semibold text-blue-400">654</span>
                                                <p class="text-xs text-slate-400">+25% vs Juni</p>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center p-2 rounded bg-slate-800/50">
                                            <span class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-green-500 text-white text-xs flex items-center justify-center">4</span>
                                                Vitamin B Complex
                                            </span>
                                            <div class="text-right">
                                                <span class="font-semibold text-green-400">589</span>
                                                <p class="text-xs text-slate-400">+3% vs Juni</p>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center p-2 rounded bg-slate-800/50">
                                            <span class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-yellow-500 text-white text-xs flex items-center justify-center">5</span>
                                                Antasida DOEN
                                            </span>
                                            <div class="text-right">
                                                <span class="font-semibold text-yellow-400">445</span>
                                                <p class="text-xs text-slate-400">-2% vs Juni</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Analisis Trend</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Total Resep Bulan Ini:</span><span class="font-semibold text-green-400">5,373</span></div>
                                        <div class="flex justify-between"><span>Peningkatan vs Juni:</span><span class="font-semibold text-green-400">+9.2%</span></div>
                                        <div class="flex justify-between"><span>Obat ISPA (%):</span><span class="font-semibold text-blue-400">42.1%</span></div>
                                        <div class="flex justify-between"><span>Obat Diare (%):</span><span class="font-semibold text-yellow-400">18.7%</span></div>
                                        <div class="flex justify-between"><span>Vitamin/Suplemen (%):</span><span class="font-semibold text-purple-400">15.3%</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="metric-card">
                                    <h4 class="font-semibold text-white mb-3">Distribusi per Puskesmas</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Sukmajaya:</span><span class="font-semibold text-red-400">1,247 resep</span></div>
                                        <div class="flex justify-between"><span>Pancoran Mas:</span><span class="font-semibold text-teal-400">986 resep</span></div>
                                        <div class="flex justify-between"><span>Beji:</span><span class="font-semibold text-blue-400">798 resep</span></div>
                                        <div class="flex justify-between"><span>Cipayung:</span><span class="font-semibold text-green-400">654 resep</span></div>
                                        <div class="flex justify-between"><span>Cilodong:</span><span class="font-semibold text-yellow-400">587 resep</span></div>
                                        <div class="flex justify-between"><span>Lainnya:</span><span class="font-semibold text-purple-400">1,101 resep</span></div>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <h4 class="font-semibold text-amber-400 mb-2">üéØ Insights & Rekomendasi</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="p-2 bg-blue-500/20 rounded border-l-2 border-blue-400">
                                            <p class="font-medium text-blue-300">Peningkatan ORS +25%</p>
                                            <p class="text-xs text-slate-400">Waspada peningkatan kasus diare, tingkatkan edukasi PHBS</p>
                                        </div>
                                        <div class="p-2 bg-yellow-500/20 rounded border-l-2 border-yellow-400">
                                            <p class="font-medium text-yellow-300">Stok Amoxicillin Rendah</p>
                                            <p class="text-xs text-slate-400">Koordinasi dengan gudang farmasi untuk restocking</p>
                                        </div>
                                        <div class="p-2 bg-green-500/20 rounded border-l-2 border-green-400">
                                            <p class="font-medium text-green-300">Rational Use of Medicine</p>
                                            <p class="text-xs text-slate-400">Evaluasi pola peresepan antibiotik, tingkatkan awareness</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                }
            };

            window.openDeepDiveModal = (type) => {
                const data = deepDiveData[type];
                if (!data) return;
                
                document.getElementById('modal-title').textContent = data.title;
                document.getElementById('modal-subtitle').textContent = data.subtitle;
                document.getElementById('modal-icon').innerHTML = `<i data-lucide="${data.icon}" class="w-7 h-7 text-white"></i>`;
                document.getElementById('modal-content').innerHTML = data.content;
                
                deepDiveModalElement.classList.remove('hidden');
                lucide.createIcons();
            };

            if (closeDeepDiveModalBtn) {
                closeDeepDiveModalBtn.addEventListener('click', () => {
                    deepDiveModalElement.classList.add('hidden');
                });
            }

            if (deepDiveModalElement) {
                deepDiveModalElement.addEventListener('click', (e) => {
                    if (e.target === deepDiveModalElement) {
                        deepDiveModalElement.classList.add('hidden');
                    }
                });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!aiChatModal.classList.contains('hidden')) closeModal();
                    if (!deepDiveModalElement.classList.contains('hidden')) deepDiveModalElement.classList.add('hidden');
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') { 
                    e.preventDefault(); 
                    openModal(); 
                }
            });

            // --- DEEP DIVE MODAL INTERACTIONS ---
            const deepDiveModal = document.getElementById('deep-dive-modal');
            const closeDeepDiveModalButton = document.getElementById('close-deep-dive-modal');
            const openDeepDiveModal = (type) => {
                const titleMap = {
                    patients: 'Detail Pasien Terdaftar',
                    visits: 'Detail Kunjungan',
                    jkn: 'Detail Cakupan JKN-KIS',
                    immunization: 'Detail Imunisasi Dasar'
                };
                const contentMap = {
                    patients: '<p>Data pasien terdaftar per bulan dengan tren dan analisis risiko.</p>',
                    visits: '<p>Detail kunjungan harian dengan segmentasi poli dan analisis.</p>',
                    jkn: '<p>Cakupan JKN-KIS dengan rincian peserta PBI dan Non-PBI.</p>',
                    immunization: '<p>Data imunisasi dasar dengan status dan rekomendasi.</p>'
                };
                document.getElementById('modal-title').textContent = titleMap[type] || 'Detail Analisis';
                document.getElementById('modal-subtitle').textContent = 'Data lengkap dan insights';
                document.getElementById('modal-content').innerHTML = contentMap[type] || '<p>Data tidak tersedia.</p>';
                deepDiveModal.classList.remove('hidden');
            };

            // Medications detail modal functions
            window.openMedicationDetail = (medicationName, index) => {
                const medicationDetails = {
                    'Paracetamol 500mg': {
                        totalPrescriptions: 1245,
                        monthlyTrend: '+8%',
                        mainIndications: ['Demam', 'Nyeri kepala', 'Myalgia'],
                        ageGroups: { child: '35%', adult: '45%', elderly: '20%' },
                        stockLevel: '23%',
                        supplier: 'Kimia Farma'
                    },
                    'Amoxicillin 500mg': {
                        totalPrescriptions: 897,
                        monthlyTrend: '+12%',
                        mainIndications: ['ISPA', 'Infeksi Saluran Kemih', 'Infeksi Kulit'],
                        ageGroups: { child: '40%', adult: '50%', elderly: '10%' },
                        stockLevel: '12%',
                        supplier: 'Dexa Medica'
                    },
                    'ORS Sachet': {
                        totalPrescriptions: 654,
                        monthlyTrend: '+25%',
                        mainIndications: ['Diare akut', 'Dehidrasi ringan', 'Gastroenteritis'],
                        ageGroups: { child: '60%', adult: '30%', elderly: '10%' },
                        stockLevel: '31%',
                        supplier: 'Otsuka'
                    }
                };

                const detail = medicationDetails[medicationName] || {
                    totalPrescriptions: topMedicationsData.datasets[0].data[index],
                    monthlyTrend: '+5%',
                    mainIndications: ['Berbagai kondisi'],
                    ageGroups: { child: '33%', adult: '34%', elderly: '33%' },
                    stockLevel: '50%',
                    supplier: 'Multi Supplier'
                };

                const stockColor = parseInt(detail.stockLevel) < 20 ? 'text-red-400' : 
                                 parseInt(detail.stockLevel) < 40 ? 'text-yellow-400' : 'text-green-400';

                const modalContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="metric-card">
                                <h4 class="font-semibold text-white mb-3">${medicationName}</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span>Total Resep Juli:</span>
                                        <span class="font-semibold text-blue-400">${detail.totalPrescriptions.toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Trend Bulanan:</span>
                                        <span class="font-semibold text-green-400">${detail.monthlyTrend}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Stok Tersisa:</span>
                                        <span class="font-semibold ${stockColor}">${detail.stockLevel}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Supplier:</span>
                                        <span class="font-semibold text-slate-300">${detail.supplier}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <h4 class="font-semibold text-white mb-3">Distribusi Usia</h4>
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span>Anak (0-17 th):</span>
                                            <span class="font-semibold">${detail.ageGroups.child}</span>
                                        </div>
                                        <div class="w-full bg-slate-600 rounded-full h-2">
                                            <div class="bg-blue-400 h-2 rounded-full" style="width: ${detail.ageGroups.child}"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span>Dewasa (18-59 th):</span>
                                            <span class="font-semibold">${detail.ageGroups.adult}</span>
                                        </div>
                                        <div class="w-full bg-slate-600 rounded-full h-2">
                                            <div class="bg-green-400 h-2 rounded-full" style="width: ${detail.ageGroups.adult}"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span>Lansia (60+ th):</span>
                                            <span class="font-semibold">${detail.ageGroups.elderly}</span>
                                        </div>
                                        <div class="w-full bg-slate-600 rounded-full h-2">
                                            <div class="bg-yellow-400 h-2 rounded-full" style="width: ${detail.ageGroups.elderly}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="metric-card">
                                <h4 class="font-semibold text-white mb-3">Indikasi Utama</h4>
                                <div class="space-y-2">
                                    ${detail.mainIndications.map((indication, i) => `
                                        <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded">
                                            <span class="w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center">${i + 1}</span>
                                            <span>${indication}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="metric-card">
                                <h4 class="font-semibold text-amber-400 mb-2">‚ö†Ô∏è Peringatan Stok</h4>
                                <div class="space-y-2 text-sm">
                                    ${parseInt(detail.stockLevel) < 20 ? `
                                        <div class="p-2 bg-red-500/20 rounded border-l-2 border-red-400">
                                            <p class="font-medium text-red-300">Stok Kritis!</p>
                                            <p class="text-xs text-slate-400">Segera lakukan pemesanan ulang</p>
                                        </div>
                                    ` : parseInt(detail.stockLevel) < 40 ? `
                                        <div class="p-2 bg-yellow-500/20 rounded border-l-2 border-yellow-400">
                                            <p class="font-medium text-yellow-300">Stok Rendah</p>
                                            <p class="text-xs text-slate-400">Persiapkan pemesanan dalam 1-2 minggu</p>
                                        </div>
                                    ` : `
                                        <div class="p-2 bg-green-500/20 rounded border-l-2 border-green-400">
                                            <p class="font-medium text-green-300">Stok Aman</p>
                                            <p class="text-xs text-slate-400">Stok mencukupi untuk 2-3 bulan ke depan</p>
                                        </div>
                                    `}
                                    <div class="p-2 bg-blue-500/20 rounded border-l-2 border-blue-400">
                                        <p class="font-medium text-blue-300">Prediksi Kebutuhan</p>
                                        <p class="text-xs text-slate-400">Estimasi kebutuhan minggu depan: ${Math.round(detail.totalPrescriptions * 0.23)} unit</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('modal-title').textContent = `Detail: ${medicationName}`;
                document.getElementById('modal-subtitle').textContent = 'Analisis pola peresepan dan status stok';
                document.getElementById('modal-icon').innerHTML = `<i data-lucide="pill" class="w-7 h-7 text-white"></i>`;
                document.getElementById('modal-content').innerHTML = modalContent;
                
                deepDiveModal.classList.remove('hidden');
                lucide.createIcons();
            };

            // Add event listener for medications detail button
            const medicationsDetailBtn = document.getElementById('medications-detail-btn');
            if (medicationsDetailBtn) {
                medicationsDetailBtn.addEventListener('click', () => {
                    window.openDeepDiveModal('medications');
                });
            }

            if(closeDeepDiveModalButton) closeDeepDiveModalButton.addEventListener('click', () => deepDiveModal.classList.add('hidden'));
            if(deepDiveModal) deepDiveModal.addEventListener('click', (e) => e.target === deepDiveModal && deepDiveModal.classList.add('hidden'));

            // --- REAL-TIME SIMULATION & ANIMATIONS ---
            setInterval(() => {
                const kunjunganElem = document.getElementById('kunjungan-hari-ini');
                if (kunjunganElem) {
                    const baseValue = parseInt(kunjunganElem.textContent) || 247;
                    kunjunganElem.textContent = baseValue + Math.floor(Math.random() * 3) - 1;
                }
                const updateTimeElem = document.getElementById('update-time');
                if(updateTimeElem) {
                    const timeString = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    updateTimeElem.textContent = `Update: ${timeString} WIB`;
                }
            }, 30000);

            setTimeout(() => {
                document.querySelectorAll('.progress-fill').forEach(bar => {
                    const finalWidth = bar.style.width;
                    bar.style.width = '0%';
                    setTimeout(() => bar.style.width = finalWidth, 100);
                });
            }, 500);

            lucide.createIcons();
        });
    </script>
</body>
</html>